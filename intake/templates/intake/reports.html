{% extends 'base.html' %}

{% block title %}{{ super() }} &dash; Intake{% endblock title %}

{% block scripts %}
    <link rel="stylesheet" href="{{ url_for('intake_bp.static', filename='css/intake.css') }}">
    <script src="{{ url_for('intake_bp.static', filename='scripts/controllers/reports.js') }}"></script>
{% endblock scripts %}

{% block content %}
{% if access_denied %}
        <div class="row">
          <div class="col-sm-12">
            <div class="alert alert-danger alert-dismissible fade show">
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <div class="info_text mb-3">
		            This area or study is not accessible for you.
                    Please click <a href="{{ url_for('intake_bp.index') }}">here</a> to go to an area that is accessible for you.
                    <br>
                    <a href="{{ url_for('intake_bp.index') }}" class="btn btn-info btn-goto-intake mt-2"><i class="fa fa-chevron-right"></i> Intake</a>
                </div>
            </div>
           </div>
        </div>

{% else %}

    <div class="page-header">
        <h1>
            <i class="fa fa-folder-open"></i>
            {{ title }}
        </h1>
    </div>

    <div id="toprow" class="mt-4">

        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fa fa-graduation-cap" aria-hidden="true"></i> Change study <span class="caret"></span>
        </button>

        <div class="dropdown-menu">
            Please select a study for your Yoda Intake Area:
            <table class="table table-hover table-striped mt-3" id="select-study">
                {% for study in studies %}
                    <tr data-study-url="{{ url_for('intake_bp.reports', studyID=study) }}">
                        <td><i class="fa fa-graduation-cap"></i></td>
                        <td>{{ study }}</td>
                        <td class="w10px">
                            {% if study==study_id %}
                                <i class="fa fa-check"></i>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>

        <a class="btn btn-outline-secondary btn-export-data mr-2" href="{{ url_for('intake_bp.export', studyID=study_id) }}" target="_blank"><i class="fa fa-download"></i> Export data</a>
        <a href="{{ url_for('intake_bp.index') }}" class="btn btn-info btn-goto-intake mr-2"><i class="fa fa-chevron-right"></i> Intake</a>
    </div>

    <div id="counts_raw" class="mt-4">
        <h1>Raw</h1>
        {% set exists = [] %}
        <table width="100%" class="table-striped dataset-type-counts-raw">
            <thead>
            <tr>
                <td><strong>Type</strong></td>
                <td><strong>Version</strong></td>
                <td><strong>Wave</strong></td>
                <td><strong>Count</strong></td>
            </tr>
            </thead>
          <tbody>
            {% set counter = 0 %}
            {% for type in datasetTypeCounts %}
                {% for wave in datasetTypeCounts[type] %}
                    {% for version in datasetTypeCounts[type][wave] %}
                        {% if version=='raw' %}
                            {% if exists.append(1) %}{% endif %}
                            <tr class="dataset-type-counts-raw">
                                <td>{{ type }}</td>
                                <td>{{ version }}</td>
                                <td>{{ wave }}</td>
                                <td>{{ datasetTypeCounts[type][wave][version] }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
            </tbody>
        </table>
        {% if not exists %}
            <i>No data found.</i>
        {% endif %}

    <div id="counts_processed" class="mt-4 mb-5">
        <h1>Processed</h1>
        {% set exists = [] %}
        <table width="100%" class="table-striped">
            <thead>
            <tr>
                <td><strong>Type</strong></td>
                <td><strong>Version</strong></td>
                <td><strong>Wave</strong></td>
                <td><strong>Count</strong></td>
            </tr>
            </thead>
            <tbody>
            {% for type in datasetTypeCounts %}
                {% for wave in datasetTypeCounts[type] %}
                    {% for version in datasetTypeCounts[type][wave] %}
                        {% if version!='raw' %}
                            {% if exists.append(1) %}{% endif %}
                            <tr class="dataset-type-counts-processed">
                                <td>{{ type }}</td>
                                <td>{{ version }}</td>
                                <td>{{ wave }}</td>
                                <td>{{ datasetTypeCounts[type][wave][version] }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
            </tbody>
        </table>
        {% if not exists %}
            <i>No data found.</i>
        {% endif %}
    </div>
    <hr>
    <div id="aggregated_results" class="row">
        <div class="col-sm-4">
            <h3>Raw</h3>
            <table class="table-striped">
                <tbody>
                {% for version in aggregatedInfo %}
                    {% if version == 'raw' %}
                        {% for descr in aggregatedInfo[version] %}
                            <tr class="dataset-aggregated-version-raw">
                                <td class="w250px">{{ title_translate[descr] }}</td>
                                <td align="right">{{ aggregatedInfo[version][descr] }}</td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-sm-4">
            <h3>Processed</h3>
            <table class="table-striped">
                <tbody>
                {% for version in aggregatedInfo %}
                    {% if version == 'notRaw' %}
                        {% for descr in aggregatedInfo[version] %}
                            <tr class="dataset-aggregated-version-processed">
                                <td class="w250px">{{ title_translate[descr] }}</td>
                                <td align="right">{{ aggregatedInfo[version][descr] }}</td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-sm-4">
            <h3>Total</h3>
            <table class="table-striped">
                <tbody>
                {% for version in aggregatedInfo %}
                    {% if version == 'total' %}
                        {% for descr in aggregatedInfo[version] %}
                            <tr class="dataset-aggregated-version-total">
                                <td class="w250px">{{ title_translate[descr] }}</td>
                                <td align="right">{{ aggregatedInfo[version][descr] }}</td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    </div>
{% endif %}
{% endblock content %}
